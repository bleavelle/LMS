desc:LMS Tube Saturator
//tags: saturation distortion tube analog
//author: LMS + Claude

slider1:0<0,100,0.1>Drive (%)
slider2:0<-12,12,0.1>Output Gain (dB)
slider3:100<0,100,1>Dry/Wet (%)
slider4:0<0,100,0.1>Even Harmonics (%)
slider5:50<0,100,0.1>Odd Harmonics (%)
slider6:1<0,4,1{Warm Tube,Hot Tube,Tape,Rectifier,Fuzz}>Mode
slider7:100<20,20000,1>Tone (Hz)
slider8:0<0,100,0.1>Bias (%)

@init
  // DC blocker state
  dc_xl = 0; dc_xr = 0;
  dc_yl = 0; dc_yr = 0;
  dc_r = 1 - (220 / srate);

  // Tone filter state
  tone_yl = 0; tone_yr = 0;

  // tanh approximation (JSFX doesn't have built-in tanh)
  function tanh(x)
    local(e2x)
  (
    x > 10 ? 1 : x < -10 ? -1 : (
      e2x = exp(2 * x);
      (e2x - 1) / (e2x + 1);
    );
  );

  // Saturation functions
  function warm_tube(x, drive, bias)
    local(b)
  (
    b = x + bias * 0.1;
    b = b * (1 + drive);
    // Asymmetric soft clipping - tubes clip differently on positive vs negative
    b > 0 ? (
      b = this.tanh(b);
    ) : (
      b = this.tanh(b * 0.8) * 1.25;
    );
    b;
  );

  function hot_tube(x, drive, bias)
    local(b)
  (
    b = x + bias * 0.15;
    b = b * (1 + drive * 2);
    // Harder clipping with more asymmetry
    b > 0 ? (
      b = 1 - exp(-abs(b));
    ) : (
      b = -(1 - exp(-abs(b * 0.7))) * 1.1;
    );
    b;
  );

  function tape_sat(x, drive, bias)
    local(b)
  (
    b = x + bias * 0.05;
    b = b * (1 + drive * 1.5);
    // Tape: symmetric soft saturation with hysteresis feel
    b = (2 / $pi) * atan(b * $pi * 0.5);
    b;
  );

  function rectifier(x, drive, bias)
    local(b)
  (
    b = x + bias * 0.2;
    b = b * (1 + drive * 3);
    // Full wave rectifier style - folds negative into positive partially
    b < 0 ? b = b * (0.2 + drive * 0.1);
    b = this.tanh(b);
    b;
  );

  function fuzz(x, drive, bias)
    local(b)
  (
    b = x + bias * 0.1;
    b = b * (1 + drive * 4);
    // Hard clipping with crossover distortion
    abs(b) < 0.1 * (1 - drive * 0.5) ? (
      b = b * (0.3 + drive * 0.7);
    ) : (
      b = sign(b) * (1 - exp(-abs(b)));
    );
    b;
  );

  function apply_harmonics(x, even_mix, odd_mix)
    local(x2, x3, result)
  (
    // Even harmonics (2nd, 4th) - warm, musical
    x2 = x * x * sign(x);
    // Odd harmonics (3rd, 5th) - gritty, aggressive
    x3 = x * x * x;

    result = x + even_mix * x2 * 0.3 + odd_mix * x3 * 0.2;
    result;
  );

notice_show = 0;

@slider
  drive = slider1 / 100;
  out_gain = 10 ^ (slider2 / 20);
  dry_wet = slider3 / 100;
  even_harm = slider4 / 100;
  odd_harm = slider5 / 100;
  mode = slider6;
  bias = slider8 / 100;

  // Tone: simple lowpass
  tone_freq = slider7;
  tone_coeff = exp(-2 * $pi * tone_freq / srate);

@sample
  dry_l = spl0;
  dry_r = spl1;

  l = spl0;
  r = spl1;

  // Apply saturation based on mode
  mode == 0 ? (
    l = warm_tube(l, drive, bias);
    r = warm_tube(r, drive, bias);
  ) : mode == 1 ? (
    l = hot_tube(l, drive, bias);
    r = hot_tube(r, drive, bias);
  ) : mode == 2 ? (
    l = tape_sat(l, drive, bias);
    r = tape_sat(r, drive, bias);
  ) : mode == 3 ? (
    l = rectifier(l, drive, bias);
    r = rectifier(r, drive, bias);
  ) : (
    l = fuzz(l, drive, bias);
    r = fuzz(r, drive, bias);
  );

  // Add harmonics
  (even_harm > 0 || odd_harm > 0) ? (
    l = apply_harmonics(l, even_harm, odd_harm);
    r = apply_harmonics(r, even_harm, odd_harm);
  );

  // Tone control (lowpass filter)
  tone_freq < 19999 ? (
    tone_yl = tone_yl * tone_coeff + l * (1 - tone_coeff);
    tone_yr = tone_yr * tone_coeff + r * (1 - tone_coeff);
    l = tone_yl;
    r = tone_yr;
  );

  // Output gain
  l *= out_gain;
  r *= out_gain;

  // DC blocker (removes DC offset from asymmetric clipping)
  dc_yl = l - dc_xl + dc_r * dc_yl;
  dc_xl = l;
  l = dc_yl;

  dc_yr = r - dc_xr + dc_r * dc_yr;
  dc_xr = r;
  r = dc_yr;

  // Dry/wet mix
  spl0 = dry_l * (1 - dry_wet) + l * dry_wet;
  spl1 = dry_r * (1 - dry_wet) + r * dry_wet;

@gfx 500 270
  // Background
  gfx_r = 0.12; gfx_g = 0.08; gfx_b = 0.05;
  gfx_rect(0, 0, gfx_w, gfx_h);

  // Title
  gfx_r = 0.9; gfx_g = 0.7; gfx_b = 0.3;
  gfx_x = 10; gfx_y = 8;
  gfx_drawstr("LMS TUBE SATURATOR");

  // Mode name
  gfx_r = 0.8; gfx_g = 0.5; gfx_b = 0.2;
  gfx_x = 10; gfx_y = 28;
  mode == 0 ? gfx_drawstr("[ Warm Tube ]");
  mode == 1 ? gfx_drawstr("[ Hot Tube ]");
  mode == 2 ? gfx_drawstr("[ Tape ]");
  mode == 3 ? gfx_drawstr("[ Rectifier ]");
  mode == 4 ? gfx_drawstr("[ Fuzz ]");

  // Draw transfer curve
  center_x = gfx_w * 0.5;
  center_y = gfx_h * 0.55;
  box_w = gfx_w * 0.6;
  box_h = gfx_h * 0.6;

  // Box outline
  gfx_r = 0.3; gfx_g = 0.2; gfx_b = 0.1;
  gfx_rect(center_x - box_w/2, center_y - box_h/2, box_w, box_h);

  // Center lines
  gfx_r = 0.25; gfx_g = 0.18; gfx_b = 0.1;
  gfx_line(center_x - box_w/2, center_y, center_x + box_w/2, center_y);
  gfx_line(center_x, center_y - box_h/2, center_x, center_y + box_h/2);

  // Linear reference (diagonal)
  gfx_r = 0.3; gfx_g = 0.25; gfx_b = 0.15;
  gfx_line(center_x - box_w/2, center_y + box_h/2,
           center_x + box_w/2, center_y - box_h/2);

  // Draw the actual transfer curve
  gfx_r = 1.0; gfx_g = 0.6; gfx_b = 0.1;
  i = 0;
  loop(100,
    // Input from -1 to 1
    in = (i / 99) * 2 - 1;

    // Apply current saturation
    mode == 0 ? out = warm_tube(in, drive, bias);
    mode == 1 ? out = hot_tube(in, drive, bias);
    mode == 2 ? out = tape_sat(in, drive, bias);
    mode == 3 ? out = rectifier(in, drive, bias);
    mode == 4 ? out = fuzz(in, drive, bias);

    out = max(-1, min(1, out));

    px = center_x + in * box_w * 0.5;
    py = center_y - out * box_h * 0.5;

    i == 0 ? (
      gfx_x = px; gfx_y = py;
    ) : (
      gfx_lineto(px, py);
    );

    i += 1;
  );

  // Drive meter
  gfx_r = 0.5; gfx_g = 0.3; gfx_b = 0.1;
  meter_x = gfx_w - 40;
  meter_h = gfx_h - 60;
  gfx_rect(meter_x, 50, 20, meter_h);

  // Drive fill
  fill_h = drive * meter_h;
  drive < 0.5 ? (
    gfx_r = 0.4; gfx_g = 0.8; gfx_b = 0.2;
  ) : drive < 0.8 ? (
    gfx_r = 0.9; gfx_g = 0.7; gfx_b = 0.1;
  ) : (
    gfx_r = 1.0; gfx_g = 0.3; gfx_b = 0.1;
  );
  gfx_rect(meter_x, 50 + meter_h - fill_h, 20, fill_h);

  // Drive label
  gfx_r = 0.6; gfx_g = 0.5; gfx_b = 0.3;
  gfx_x = meter_x - 5; gfx_y = gfx_h - 15;
  gfx_drawstr("DRIVE");
  // --- NOTICE BUTTON ---
  notice_btn_x = gfx_w - 60;
  notice_btn_y = gfx_h - 18;
  gfx_r = 0.6; gfx_g = 0.5; gfx_b = 0.3;
  gfx_rect(notice_btn_x, notice_btn_y, 55, 15);
  gfx_r = 0; gfx_g = 0; gfx_b = 0;
  gfx_x = notice_btn_x + 4; gfx_y = notice_btn_y + 2;
  gfx_drawstr("NOTICE");
  (mouse_cap & 1) && mouse_x >= notice_btn_x && mouse_x <= notice_btn_x + 55 && mouse_y >= notice_btn_y && mouse_y <= notice_btn_y + 15 && !notice_clicked ? (
    notice_show = !notice_show;
    notice_clicked = 1;
  );
  !(mouse_cap & 1) ? notice_clicked = 0;
  notice_show ? (
    gfx_r = 0.05; gfx_g = 0.05; gfx_b = 0.05; gfx_a = 0.95;
    gfx_rect(0, 0, gfx_w, gfx_h);
    gfx_a = 1;
    gfx_r = 0.9; gfx_g = 0.8; gfx_b = 0.5;
    gfx_x = 15; gfx_y = 10;
    gfx_drawstr("NOTICE: THEY ARE TRYING TO STEAL YOUR COMPUTER");
    gfx_r = 0.7; gfx_g = 0.7; gfx_b = 0.7;
    gfx_x = 15; gfx_y = 30;
    gfx_drawstr("The algorithms in our favorite software are decades old.");
    gfx_x = 15; gfx_y = 45;
    gfx_drawstr("A mathematical model is a truth about the world,");
    gfx_x = 15; gfx_y = 60;
    gfx_drawstr("not a copyrightable product. You do not have to stay");
    gfx_x = 15; gfx_y = 75;
    gfx_drawstr("a slave to subscription software. Install Linux.");
    gfx_x = 15; gfx_y = 90;
    gfx_drawstr("Build your own tools. Believe in yourself.");
    gfx_r = 0.5; gfx_g = 0.7; gfx_b = 1.0;
    gfx_x = 15; gfx_y = 115;
    gfx_drawstr("github.com/bleavelle");
    gfx_r = 0.4; gfx_g = 0.4; gfx_b = 0.4;
    gfx_x = 15; gfx_y = 140;
    gfx_r = 0.6; gfx_g = 0.5; gfx_b = 0.3;
    gfx_rect(notice_btn_x, notice_btn_y, 55, 15);
    gfx_r = 0; gfx_g = 0; gfx_b = 0;
    gfx_x = notice_btn_x + 4; gfx_y = notice_btn_y + 2;
    gfx_drawstr("NOTICE");
  );
