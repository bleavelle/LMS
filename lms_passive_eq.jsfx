desc:LMS Passive EQ
//tags: equalizer passive analog tube
//author: LMS + Claude

// Classic Passive EQ emulation
// - Low boost + cut interact (slightly offset frequencies = the magic dip-and-bump)
// - High boost with bandwidth control
// - High cut (gentle rolloff)
// - Tube saturation stage

slider1:0<0,10,0.1>Low Boost
slider2:0<0,10,0.1>Low Atten
slider3:2<0,3,1{20,30,60,100}>Low Freq
slider4:0<0,10,0.1>High Boost
slider5:5<1,10,1>High Boost BW (Broad-Sharp)
slider6:0<0,10,0.1>High Atten (Cut)
slider7:2<0,4,1{3k,4k,5k,8k,10k,12k,16k}>High Boost Freq
slider8:0<0,1,1{Off,On}>Tube Saturation
slider9:0<-12,12,0.1>Output (dB)

@init
// Biquad filter states (L and R for each band)
// Low boost: 0-3 = L state, 4-7 = R state
// Low cut: 8-15
// High boost: 16-23
// High cut: 24-31

// Low boost filter state
lb_xl1 = 0; lb_xl2 = 0; lb_yl1 = 0; lb_yl2 = 0;
lb_xr1 = 0; lb_xr2 = 0; lb_yr1 = 0; lb_yr2 = 0;

// Low cut filter state
lc_xl1 = 0; lc_xl2 = 0; lc_yl1 = 0; lc_yl2 = 0;
lc_xr1 = 0; lc_xr2 = 0; lc_yr1 = 0; lc_yr2 = 0;

// High boost filter state
hb_xl1 = 0; hb_xl2 = 0; hb_yl1 = 0; hb_yl2 = 0;
hb_xr1 = 0; hb_xr2 = 0; hb_yr1 = 0; hb_yr2 = 0;

// High cut filter state
hc_xl1 = 0; hc_xl2 = 0; hc_yl1 = 0; hc_yl2 = 0;
hc_xr1 = 0; hc_xr2 = 0; hc_yr1 = 0; hc_yr2 = 0;

// Filter coefficients
lb_b0 = 1; lb_b1 = 0; lb_b2 = 0; lb_a1 = 0; lb_a2 = 0;
lc_b0 = 1; lc_b1 = 0; lc_b2 = 0; lc_a1 = 0; lc_a2 = 0;
hb_b0 = 1; hb_b1 = 0; hb_b2 = 0; hb_a1 = 0; hb_a2 = 0;
hc_b0 = 1; hc_b1 = 0; hc_b2 = 0; hc_a1 = 0; hc_a2 = 0;

notice_show = 0;

@slider
  // === LOW FREQUENCY SELECTION ===
  slider3 == 0 ? low_freq = 20;
  slider3 == 1 ? low_freq = 30;
  slider3 == 2 ? low_freq = 60;
  slider3 == 3 ? low_freq = 100;

  // === HIGH FREQUENCY SELECTION ===
  slider7 == 0 ? high_freq = 3000;
  slider7 == 1 ? high_freq = 4000;
  slider7 == 2 ? high_freq = 5000;
  slider7 == 3 ? high_freq = 8000;
  slider7 == 4 ? high_freq = 10000;
  slider7 == 5 ? high_freq = 12000;
  slider7 == 6 ? high_freq = 16000;

  low_boost_amt = slider1;
  low_cut_amt = slider2;
  high_boost_amt = slider4;
  high_bw = slider5;
  high_cut_amt = slider6;
  tube_on = slider8;
  out_gain = 10 ^ (slider9 / 20);

  // === LOW BOOST (low shelf, broad Q) ===
  // passive EQ boost is broad and gentle
  low_boost_amt > 0 ? (
    gain_db = low_boost_amt * 1.8;  // up to ~18dB
    A = 10 ^ (gain_db / 40);
    w0 = 2 * $pi * low_freq / srate;
    cs = cos(w0); sn = sin(w0);
    // Broad Q for boost (passive-style)
    alpha = sn / (2 * 0.4);
    a0_inv = 1 / ((A + 1) + (A - 1) * cs + 2 * sqrt(A) * alpha);
    lb_b0 = A * ((A + 1) - (A - 1) * cs + 2 * sqrt(A) * alpha) * a0_inv;
    lb_b1 = 2 * A * ((A - 1) - (A + 1) * cs) * a0_inv;
    lb_b2 = A * ((A + 1) - (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
    lb_a1 = -2 * ((A - 1) + (A + 1) * cs) * a0_inv;
    lb_a2 = ((A + 1) + (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
  ) : (
    lb_b0 = 1; lb_b1 = 0; lb_b2 = 0; lb_a1 = 0; lb_a2 = 0;
  );

  // === LOW CUT (low shelf cut, slightly higher freq + narrower Q) ===
  // The magic: cut frequency is offset ~1.5x higher than boost
  // This creates the classic passive EQ "dip then bump" curve
  low_cut_amt > 0 ? (
    gain_db = -low_cut_amt * 1.8;
    A = 10 ^ (gain_db / 40);
    cut_freq = low_freq * 1.5;  // offset higher
    w0 = 2 * $pi * cut_freq / srate;
    cs = cos(w0); sn = sin(w0);
    // Narrower Q for cut
    alpha = sn / (2 * 0.7);
    a0_inv = 1 / ((A + 1) + (A - 1) * cs + 2 * sqrt(A) * alpha);
    lc_b0 = A * ((A + 1) - (A - 1) * cs + 2 * sqrt(A) * alpha) * a0_inv;
    lc_b1 = 2 * A * ((A - 1) - (A + 1) * cs) * a0_inv;
    lc_b2 = A * ((A + 1) - (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
    lc_a1 = -2 * ((A - 1) + (A + 1) * cs) * a0_inv;
    lc_a2 = ((A + 1) + (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
  ) : (
    lc_b0 = 1; lc_b1 = 0; lc_b2 = 0; lc_a1 = 0; lc_a2 = 0;
  );

  // === HIGH BOOST (peaking EQ with variable bandwidth) ===
  high_boost_amt > 0 ? (
    gain_db = high_boost_amt * 1.5;  // up to ~15dB
    A = 10 ^ (gain_db / 40);
    w0 = 2 * $pi * high_freq / srate;
    cs = cos(w0); sn = sin(w0);
    // BW slider: 1=broad (low Q), 10=sharp (high Q)
    Q = 0.3 + (high_bw - 1) * 0.3;  // Q from 0.3 to 3.0
    alpha = sn / (2 * Q);
    a0_inv = 1 / (1 + alpha / A);
    hb_b0 = (1 + alpha * A) * a0_inv;
    hb_b1 = -2 * cs * a0_inv;
    hb_b2 = (1 - alpha * A) * a0_inv;
    hb_a1 = -2 * cs * a0_inv;
    hb_a2 = (1 - alpha / A) * a0_inv;
  ) : (
    hb_b0 = 1; hb_b1 = 0; hb_b2 = 0; hb_a1 = 0; hb_a2 = 0;
  );

  // === HIGH CUT (low-pass shelf rolloff) ===
  high_cut_amt > 0 ? (
    gain_db = -high_cut_amt * 1.5;
    A = 10 ^ (gain_db / 40);
    // Cut at 10k-20k range, gentle rolloff
    hc_freq = 10000;
    w0 = 2 * $pi * hc_freq / srate;
    cs = cos(w0); sn = sin(w0);
    alpha = sn / (2 * 0.5);
    // High shelf (cutting)
    a0_inv = 1 / ((A + 1) - (A - 1) * cs + 2 * sqrt(A) * alpha);
    hc_b0 = A * ((A + 1) + (A - 1) * cs + 2 * sqrt(A) * alpha) * a0_inv;
    hc_b1 = -2 * A * ((A - 1) + (A + 1) * cs) * a0_inv;
    hc_b2 = A * ((A + 1) + (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
    hc_a1 = 2 * ((A - 1) - (A + 1) * cs) * a0_inv;
    hc_a2 = ((A + 1) - (A - 1) * cs - 2 * sqrt(A) * alpha) * a0_inv;
  ) : (
    hc_b0 = 1; hc_b1 = 0; hc_b2 = 0; hc_a1 = 0; hc_a2 = 0;
  );

@sample
  l = spl0;
  r = spl1;

  // === LOW BOOST ===
  low_boost_amt > 0 ? (
    ol = lb_b0 * l + lb_b1 * lb_xl1 + lb_b2 * lb_xl2 - lb_a1 * lb_yl1 - lb_a2 * lb_yl2;
    lb_xl2 = lb_xl1; lb_xl1 = l; lb_yl2 = lb_yl1; lb_yl1 = ol; l = ol;
    ol = lb_b0 * r + lb_b1 * lb_xr1 + lb_b2 * lb_xr2 - lb_a1 * lb_yr1 - lb_a2 * lb_yr2;
    lb_xr2 = lb_xr1; lb_xr1 = r; lb_yr2 = lb_yr1; lb_yr1 = ol; r = ol;
  );

  // === LOW CUT ===
  low_cut_amt > 0 ? (
    ol = lc_b0 * l + lc_b1 * lc_xl1 + lc_b2 * lc_xl2 - lc_a1 * lc_yl1 - lc_a2 * lc_yl2;
    lc_xl2 = lc_xl1; lc_xl1 = l; lc_yl2 = lc_yl1; lc_yl1 = ol; l = ol;
    ol = lc_b0 * r + lc_b1 * lc_xr1 + lc_b2 * lc_xr2 - lc_a1 * lc_yr1 - lc_a2 * lc_yr2;
    lc_xr2 = lc_xr1; lc_xr1 = r; lc_yr2 = lc_yr1; lc_yr1 = ol; r = ol;
  );

  // === HIGH BOOST ===
  high_boost_amt > 0 ? (
    ol = hb_b0 * l + hb_b1 * hb_xl1 + hb_b2 * hb_xl2 - hb_a1 * hb_yl1 - hb_a2 * hb_yl2;
    hb_xl2 = hb_xl1; hb_xl1 = l; hb_yl2 = hb_yl1; hb_yl1 = ol; l = ol;
    ol = hb_b0 * r + hb_b1 * hb_xr1 + hb_b2 * hb_xr2 - hb_a1 * hb_yr1 - hb_a2 * hb_yr2;
    hb_xr2 = hb_xr1; hb_xr1 = r; hb_yr2 = hb_yr1; hb_yr1 = ol; r = ol;
  );

  // === HIGH CUT ===
  high_cut_amt > 0 ? (
    ol = hc_b0 * l + hc_b1 * hc_xl1 + hc_b2 * hc_xl2 - hc_a1 * hc_yl1 - hc_a2 * hc_yl2;
    hc_xl2 = hc_xl1; hc_xl1 = l; hc_yl2 = hc_yl1; hc_yl1 = ol; l = ol;
    ol = hc_b0 * r + hc_b1 * hc_xr1 + hc_b2 * hc_xr2 - hc_a1 * hc_yr1 - hc_a2 * hc_yr2;
    hc_xr2 = hc_xr1; hc_xr1 = r; hc_yr2 = hc_yr1; hc_yr1 = ol; r = ol;
  );

  // === TUBE SATURATION ===
  tube_on ? (
    // Gentle tube-like even harmonic saturation
    // Asymmetric soft clip for even harmonics
    drive = 1.5;
    x = l * drive; e = exp(2*x); t1 = (e - 1) / (e + 1);
    x = l * l * 0.3; e = exp(2*x); t2 = (e - 1) / (e + 1);
    l = (t1 + t2 * 0.15) / 1.15;

    x = r * drive; e = exp(2*x); t1 = (e - 1) / (e + 1);
    x = r * r * 0.3; e = exp(2*x); t2 = (e - 1) / (e + 1);
    r = (t1 + t2 * 0.15) / 1.15;
  );

  // === OUTPUT ===
  spl0 = l * out_gain;
  spl1 = r * out_gain;

@gfx 500 240
  // Background - warm cream like a real passive EQ
  gfx_r = 0.12; gfx_g = 0.10; gfx_b = 0.06;
  gfx_rect(0, 0, gfx_w, gfx_h);

  // Title
  gfx_r = 0.9; gfx_g = 0.8; gfx_b = 0.5;
  gfx_x = 10; gfx_y = 8;
  gfx_drawstr("LMS PASSIVE EQ");

  // Low section
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_x = 10; gfx_y = 32;
  gfx_drawstr("LOW ");
  gfx_r = 0.8; gfx_g = 0.7; gfx_b = 0.4;
  gfx_drawnumber(low_freq, 0);
  gfx_drawstr(" Hz");

  gfx_x = 10; gfx_y = 50;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("  Boost: ");
  gfx_r = 0.4; gfx_g = 0.8; gfx_b = 0.4;
  gfx_drawnumber(low_boost_amt, 1);

  gfx_x = 140; gfx_y = 50;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("  Atten: ");
  gfx_r = 0.8; gfx_g = 0.4; gfx_b = 0.3;
  gfx_drawnumber(low_cut_amt, 1);

  // Boost+Cut interaction indicator
  low_boost_amt > 0 && low_cut_amt > 0 ? (
    gfx_x = 10; gfx_y = 68;
    gfx_r = 0.9; gfx_g = 0.7; gfx_b = 0.3;
    gfx_drawstr("  >> Boost+Atten interaction active");
  );

  // High section
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_x = 10; gfx_y = 90;
  gfx_drawstr("HIGH ");
  gfx_r = 0.8; gfx_g = 0.7; gfx_b = 0.4;
  gfx_drawnumber(high_freq, 0);
  gfx_drawstr(" Hz");

  gfx_x = 10; gfx_y = 108;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("  Boost: ");
  gfx_r = 0.4; gfx_g = 0.8; gfx_b = 0.4;
  gfx_drawnumber(high_boost_amt, 1);

  gfx_x = 140; gfx_y = 108;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("  BW: ");
  gfx_r = 0.6; gfx_g = 0.6; gfx_b = 0.8;
  gfx_drawnumber(high_bw, 0);

  gfx_x = 10; gfx_y = 126;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("  Atten: ");
  gfx_r = 0.8; gfx_g = 0.4; gfx_b = 0.3;
  gfx_drawnumber(high_cut_amt, 1);

  // Tube
  gfx_x = 10; gfx_y = 152;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("TUBE: ");
  tube_on ? (
    gfx_r = 1.0; gfx_g = 0.6; gfx_b = 0.2;
    gfx_drawstr("ON");
  ) : (
    gfx_r = 0.3; gfx_g = 0.3; gfx_b = 0.4;
    gfx_drawstr("Off");
  );

  // Output
  gfx_x = 10; gfx_y = 176;
  gfx_r = 0.5; gfx_g = 0.5; gfx_b = 0.5;
  gfx_drawstr("Output: ");
  gfx_r = 0.7; gfx_g = 0.7; gfx_b = 0.7;
  gfx_drawnumber(slider9, 1);
  gfx_drawstr(" dB");
  // --- NOTICE BUTTON ---
  notice_btn_x = gfx_w - 60;
  notice_btn_y = gfx_h - 18;
  gfx_r = 0.6; gfx_g = 0.5; gfx_b = 0.3;
  gfx_rect(notice_btn_x, notice_btn_y, 55, 15);
  gfx_r = 0; gfx_g = 0; gfx_b = 0;
  gfx_x = notice_btn_x + 4; gfx_y = notice_btn_y + 2;
  gfx_drawstr("NOTICE");
  (mouse_cap & 1) && mouse_x >= notice_btn_x && mouse_x <= notice_btn_x + 55 && mouse_y >= notice_btn_y && mouse_y <= notice_btn_y + 15 && !notice_clicked ? (
    notice_show = !notice_show;
    notice_clicked = 1;
  );
  !(mouse_cap & 1) ? notice_clicked = 0;
  notice_show ? (
    gfx_r = 0.05; gfx_g = 0.05; gfx_b = 0.05; gfx_a = 0.95;
    gfx_rect(0, 0, gfx_w, gfx_h);
    gfx_a = 1;
    gfx_r = 0.9; gfx_g = 0.8; gfx_b = 0.5;
    gfx_x = 15; gfx_y = 10;
    gfx_drawstr("NOTICE: THEY ARE TRYING TO STEAL YOUR COMPUTER");
    gfx_r = 0.7; gfx_g = 0.7; gfx_b = 0.7;
    gfx_x = 15; gfx_y = 30;
    gfx_drawstr("The algorithms in our favorite software are decades old.");
    gfx_x = 15; gfx_y = 45;
    gfx_drawstr("A mathematical model is a truth about the world,");
    gfx_x = 15; gfx_y = 60;
    gfx_drawstr("not a copyrightable product. You do not have to stay");
    gfx_x = 15; gfx_y = 75;
    gfx_drawstr("a slave to subscription software. Install Linux.");
    gfx_x = 15; gfx_y = 90;
    gfx_drawstr("Build your own tools. Believe in yourself.");
    gfx_r = 0.5; gfx_g = 0.7; gfx_b = 1.0;
    gfx_x = 15; gfx_y = 115;
    gfx_drawstr("github.com/bleavelle");
    gfx_r = 0.4; gfx_g = 0.4; gfx_b = 0.4;
    gfx_x = 15; gfx_y = 140;
    gfx_r = 0.6; gfx_g = 0.5; gfx_b = 0.3;
    gfx_rect(notice_btn_x, notice_btn_y, 55, 15);
    gfx_r = 0; gfx_g = 0; gfx_b = 0;
    gfx_x = notice_btn_x + 4; gfx_y = notice_btn_y + 2;
    gfx_drawstr("NOTICE");
  );
