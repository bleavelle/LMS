desc:Galaxy Tape Echo
//tags: delay echo tape analog
//author: Bryan + Claude

slider1:0<0,6,1{Head 1,Head 2,Head 3,Heads 1+2,Heads 1+3,Heads 2+3,All Heads}>Mode
slider2:300<50,1000,1>Repeat Rate (ms)
slider3:40<0,100,0.1>Intensity (%)
slider4:80<0,100,0.1>Echo Volume (%)
slider5:50<0,100,1>Bass (%)
slider6:50<0,100,1>Treble (%)
slider7:30<0,100,1>Wow & Flutter (%)
slider8:30<0,100,1>Tape Age (%)
slider9:0<0,100,1>Spring Reverb (%)
slider10:50<0,100,1>Dry/Wet (%)

@init
  // Delay buffer - max 2 seconds
  buf_max = floor(srate * 2);
  buf_l = 0;
  buf_r = buf_max;
  wpos = 0;

  memset(buf_l, 0, buf_max);
  memset(buf_r, 0, buf_max);

  // Feedback lowpass state
  fb_lp_l = 0; fb_lp_r = 0;

  // Feedback signal (persists between samples)
  fb_l = 0; fb_r = 0;

  // Wow/flutter LFO phases
  wow_phase = 0;
  flutter_phase = 0;

  // Tape reel animation
  reel_angle = 0;

  // Spring reverb buffers (6 allpass + 2 comb delays)
  // Allpass delays - prime-ish numbers for diffusion
  sp_base = buf_max * 2 + 100;
  sp_ap1_len = 113;  sp_ap1_buf = sp_base;              sp_ap1_pos = 0;
  sp_ap2_len = 337;  sp_ap2_buf = sp_ap1_buf + sp_ap1_len; sp_ap2_pos = 0;
  sp_ap3_len = 547;  sp_ap3_buf = sp_ap2_buf + sp_ap2_len; sp_ap3_pos = 0;
  sp_ap4_len = 751;  sp_ap4_buf = sp_ap3_buf + sp_ap3_len; sp_ap4_pos = 0;
  sp_ap5_len = 1153; sp_ap5_buf = sp_ap4_buf + sp_ap4_len; sp_ap5_pos = 0;
  sp_ap6_len = 1597; sp_ap6_buf = sp_ap5_buf + sp_ap5_len; sp_ap6_pos = 0;
  // Comb delays for the spring bounce character
  sp_cm1_len = floor(srate * 0.035);  // ~35ms spring transit
  sp_cm2_len = floor(srate * 0.043);  // slightly offset
  sp_cm1_buf = sp_ap6_buf + sp_ap6_len; sp_cm1_pos = 0;
  sp_cm2_buf = sp_cm1_buf + sp_cm1_len; sp_cm2_pos = 0;
  // Clear spring buffers
  memset(sp_base, 0, sp_cm2_buf + sp_cm2_len - sp_base);
  // Spring lowpass state
  sp_lp_l = 0; sp_lp_r = 0;
  // Spring damping
  sp_damp_coeff = exp(-2 * $pi * 4000 / srate);

  // tanh approximation
  function tanh(x) local(e2x) (
    x > 10 ? 1 : x < -10 ? -1 : (
      e2x = exp(2 * x);
      (e2x - 1) / (e2x + 1);
    );
  );

  // Cubic interpolation read from delay buffer
  function buf_read_cubic(buf, pos, bmax)
    local(p0, p1, p2, p3, x0, x1, x2, x3, a, b, c, d, frac, idx)
  (
    idx = floor(pos);
    frac = pos - idx;

    p0 = idx - 1; p0 < 0 ? p0 += bmax;
    p1 = idx;     p1 >= bmax ? p1 -= bmax;
    p2 = idx + 1; p2 >= bmax ? p2 -= bmax;
    p3 = idx + 2; p3 >= bmax ? p3 -= bmax;

    x0 = buf[p0]; x1 = buf[p1]; x2 = buf[p2]; x3 = buf[p3];

    // Cubic Hermite interpolation
    a = -0.5*x0 + 1.5*x1 - 1.5*x2 + 0.5*x3;
    b = x0 - 2.5*x1 + 2*x2 - 0.5*x3;
    c = -0.5*x0 + 0.5*x2;
    d = x1;

    ((a * frac + b) * frac + c) * frac + d;
  );

  // Spring allpass filter
  function spring_ap(buf, pos, len, input, coeff)
    local(delayed, output)
  (
    delayed = buf[pos];
    output = -input * coeff + delayed;
    buf[pos] = input + delayed * coeff;
    output;
  );

  // Tape saturation (asymmetric, like real tape)
  function tape_sat(x, age)
    local(drive, b)
  (
    drive = 1 + age * 3;
    b = x * drive;
    b > 0 ? (
      b = this.tanh(b);
    ) : (
      b = this.tanh(b * 0.85) * 1.18;
    );
    b / drive * (1 + age * 0.5); // compensate gain, slight warmth boost
  );

@slider
  mode = slider1;
  delay_ms = slider2;
  intensity = slider3 / 100;
  echo_vol = slider4 / 100;
  bass = slider5 / 100;
  treble = slider6 / 100;
  wf_amount = slider7 / 100;
  tape_age = slider8 / 100;
  spring_mix = slider9 / 100;
  dry_wet = slider10 / 100;

  // Base delay in samples (Head 1)
  delay_base = delay_ms / 1000 * srate;

  // Head positions (RE-201 spacing ratios)
  head1_delay = delay_base;
  head2_delay = delay_base * 1.5;
  head3_delay = delay_base * 2.0;

  // Which heads are active
  h1_on = (mode == 0 || mode == 3 || mode == 4 || mode == 6) ? 1 : 0;
  h2_on = (mode == 1 || mode == 3 || mode == 5 || mode == 6) ? 1 : 0;
  h3_on = (mode == 2 || mode == 4 || mode == 5 || mode == 6) ? 1 : 0;
  num_heads = h1_on + h2_on + h3_on;
  num_heads < 1 ? num_heads = 1;

  // Feedback lowpass cutoff (treble + tape age darken it)
  fb_lp_freq = 800 + treble * 8000 - tape_age * 3000;
  fb_lp_freq = max(fb_lp_freq, 400);
  fb_lp_freq = min(fb_lp_freq, 12000);
  fb_lp_coeff = exp(-2 * $pi * fb_lp_freq / srate);

  // Bass tone: simple one-pole highpass amount (less bass = more highpass)
  bass_hp_freq = 60 + (1 - bass) * 400;
  bass_hp_coeff = exp(-2 * $pi * bass_hp_freq / srate);

@sample
  // --- Wow & Flutter modulation ---
  wow_phase += 0.5 / srate;   // 0.5 Hz
  wow_phase >= 1 ? wow_phase -= 1;
  flutter_phase += 6.3 / srate; // ~6.3 Hz
  flutter_phase >= 1 ? flutter_phase -= 1;

  // Wow: triangle wave for natural drift
  wow_val = wow_phase < 0.5 ? (wow_phase * 4 - 1) : (3 - wow_phase * 4);
  // Flutter: sine
  flutter_val = sin(2 * $pi * flutter_phase);

  // Modulation in samples
  wow_mod = wow_val * wf_amount * 3.0 * srate / 1000;      // ±3ms max
  flutter_mod = flutter_val * wf_amount * 0.5 * srate / 1000; // ±0.5ms max
  total_mod = wow_mod + flutter_mod;

  // --- Write to delay buffer (input + feedback with tape saturation) ---
  tape_in_l = spl0 + fb_l * intensity;
  tape_in_r = spl1 + fb_r * intensity;

  // Tape saturation on the signal going to tape
  tape_age > 0.01 ? (
    tape_in_l = tape_sat(tape_in_l, tape_age);
    tape_in_r = tape_sat(tape_in_r, tape_age);
  );

  buf_l[wpos] = tape_in_l;
  buf_r[wpos] = tape_in_r;

  // --- Read from heads ---
  wet_l = 0; wet_r = 0;

  h1_on ? (
    rd = wpos - head1_delay - total_mod;
    rd < 0 ? rd += buf_max;
    rd >= buf_max ? rd -= buf_max;
    wet_l += buf_read_cubic(buf_l, rd, buf_max);
    wet_r += buf_read_cubic(buf_r, rd, buf_max);
  );

  h2_on ? (
    rd = wpos - head2_delay - total_mod;
    rd < 0 ? rd += buf_max;
    rd >= buf_max ? rd -= buf_max;
    wet_l += buf_read_cubic(buf_l, rd, buf_max);
    wet_r += buf_read_cubic(buf_r, rd, buf_max);
  );

  h3_on ? (
    rd = wpos - head3_delay - total_mod;
    rd < 0 ? rd += buf_max;
    rd >= buf_max ? rd -= buf_max;
    wet_l += buf_read_cubic(buf_l, rd, buf_max);
    wet_r += buf_read_cubic(buf_r, rd, buf_max);
  );

  // Scale by number of active heads to prevent volume jumps
  wet_l /= num_heads;
  wet_r /= num_heads;

  // --- Feedback path: lowpass filter (tape loses highs each pass) ---
  fb_lp_l = fb_lp_l * fb_lp_coeff + wet_l * (1 - fb_lp_coeff);
  fb_lp_r = fb_lp_r * fb_lp_coeff + wet_r * (1 - fb_lp_coeff);
  fb_l = fb_lp_l;
  fb_r = fb_lp_r;

  // --- Tone shaping on wet output ---
  // Simple bass cut (highpass) when bass is low
  bass < 0.99 ? (
    wet_l = wet_l - (wet_l * bass_hp_coeff + fb_lp_l * (1 - bass_hp_coeff)) * (1 - bass);
    wet_r = wet_r - (wet_r * bass_hp_coeff + fb_lp_r * (1 - bass_hp_coeff)) * (1 - bass);
  );

  // Apply echo volume
  wet_l *= echo_vol;
  wet_r *= echo_vol;

  // --- Spring Reverb (post echo, like the RE-201) ---
  spring_mix > 0 ? (
    // Feed the echo output into the spring
    sp_in = (wet_l + wet_r) * 0.5;

    // Allpass diffusion chain (creates spring-like dispersion)
    sp_in = spring_ap(sp_ap1_buf, sp_ap1_pos, sp_ap1_len, sp_in, 0.6);
    sp_ap1_pos += 1; sp_ap1_pos >= sp_ap1_len ? sp_ap1_pos = 0;
    sp_in = spring_ap(sp_ap2_buf, sp_ap2_pos, sp_ap2_len, sp_in, 0.6);
    sp_ap2_pos += 1; sp_ap2_pos >= sp_ap2_len ? sp_ap2_pos = 0;
    sp_in = spring_ap(sp_ap3_buf, sp_ap3_pos, sp_ap3_len, sp_in, 0.55);
    sp_ap3_pos += 1; sp_ap3_pos >= sp_ap3_len ? sp_ap3_pos = 0;
    sp_in = spring_ap(sp_ap4_buf, sp_ap4_pos, sp_ap4_len, sp_in, 0.55);
    sp_ap4_pos += 1; sp_ap4_pos >= sp_ap4_len ? sp_ap4_pos = 0;
    sp_in = spring_ap(sp_ap5_buf, sp_ap5_pos, sp_ap5_len, sp_in, 0.5);
    sp_ap5_pos += 1; sp_ap5_pos >= sp_ap5_len ? sp_ap5_pos = 0;
    sp_in = spring_ap(sp_ap6_buf, sp_ap6_pos, sp_ap6_len, sp_in, 0.5);
    sp_ap6_pos += 1; sp_ap6_pos >= sp_ap6_len ? sp_ap6_pos = 0;

    // Comb delays for spring bounce character (with feedback + damping)
    cm1_out = sp_cm1_buf[sp_cm1_pos];
    cm2_out = sp_cm2_buf[sp_cm2_pos];

    // Damping lowpass in the comb feedback
    sp_lp_l = sp_lp_l * sp_damp_coeff + cm1_out * (1 - sp_damp_coeff);
    sp_lp_r = sp_lp_r * sp_damp_coeff + cm2_out * (1 - sp_damp_coeff);

    sp_cm1_buf[sp_cm1_pos] = sp_in + sp_lp_l * 0.45;
    sp_cm2_buf[sp_cm2_pos] = sp_in + sp_lp_r * 0.40;
    sp_cm1_pos += 1; sp_cm1_pos >= sp_cm1_len ? sp_cm1_pos = 0;
    sp_cm2_pos += 1; sp_cm2_pos >= sp_cm2_len ? sp_cm2_pos = 0;

    // Stereo spring output (slightly different mix L/R)
    sp_out_l = cm1_out * 0.6 + cm2_out * 0.4;
    sp_out_r = cm1_out * 0.4 + cm2_out * 0.6;

    // Mix spring into wet signal
    wet_l += sp_out_l * spring_mix;
    wet_r += sp_out_r * spring_mix;
  );

  // --- Dry/Wet mix ---
  spl0 = spl0 * (1 - dry_wet) + wet_l * dry_wet;
  spl1 = spl1 * (1 - dry_wet) + wet_r * dry_wet;

  // Advance write position
  wpos += 1;
  wpos >= buf_max ? wpos = 0;

@gfx 500 220
  // Background - dark green/silver (RE-201 vibe)
  gfx_r = 0.06; gfx_g = 0.09; gfx_b = 0.06;
  gfx_rect(0, 0, gfx_w, gfx_h);

  // Top panel stripe
  gfx_r = 0.15; gfx_g = 0.2; gfx_b = 0.12;
  gfx_rect(0, 0, gfx_w, 45);

  // Title
  gfx_r = 0.85; gfx_g = 0.9; gfx_b = 0.75;
  gfx_x = 12; gfx_y = 6;
  gfx_drawstr("GALAXY TAPE ECHO");

  // Mode name
  gfx_r = 0.6; gfx_g = 0.75; gfx_b = 0.5;
  gfx_x = 12; gfx_y = 24;
  mode == 0 ? gfx_drawstr("[ Head 1 ]");
  mode == 1 ? gfx_drawstr("[ Head 2 ]");
  mode == 2 ? gfx_drawstr("[ Head 3 ]");
  mode == 3 ? gfx_drawstr("[ Heads 1+2 ]");
  mode == 4 ? gfx_drawstr("[ Heads 1+3 ]");
  mode == 5 ? gfx_drawstr("[ Heads 2+3 ]");
  mode == 6 ? gfx_drawstr("[ All Heads ]");

  // Delay time display
  gfx_r = 0.5; gfx_g = 0.6; gfx_b = 0.4;
  gfx_x = gfx_w - 100; gfx_y = 8;
  gfx_drawnumber(delay_ms, 0);
  gfx_drawstr(" ms");
  gfx_x = gfx_w - 100; gfx_y = 24;
  gfx_drawstr("Intensity: ");
  gfx_drawnumber(intensity * 100, 0);
  gfx_drawstr("%");

  // --- Tape reels ---
  reel_angle += 0.02 + intensity * 0.03;
  reel_angle >= 2 * $pi ? reel_angle -= 2 * $pi;

  reel_cx1 = gfx_w * 0.3;
  reel_cx2 = gfx_w * 0.7;
  reel_cy = gfx_h * 0.52;
  reel_r = min(gfx_w * 0.12, gfx_h * 0.22);

  // Left reel
  gfx_r = 0.25; gfx_g = 0.3; gfx_b = 0.2;
  gfx_circle(reel_cx1, reel_cy, reel_r, 1);
  gfx_r = 0.1; gfx_g = 0.13; gfx_b = 0.08;
  gfx_circle(reel_cx1, reel_cy, reel_r * 0.4, 1);
  // Spokes
  gfx_r = 0.35; gfx_g = 0.4; gfx_b = 0.3;
  i = 0;
  loop(3,
    a = reel_angle + i * 2 * $pi / 3;
    gfx_line(reel_cx1, reel_cy,
             reel_cx1 + cos(a) * reel_r * 0.85,
             reel_cy + sin(a) * reel_r * 0.85);
    i += 1;
  );

  // Right reel
  gfx_r = 0.25; gfx_g = 0.3; gfx_b = 0.2;
  gfx_circle(reel_cx2, reel_cy, reel_r, 1);
  gfx_r = 0.1; gfx_g = 0.13; gfx_b = 0.08;
  gfx_circle(reel_cx2, reel_cy, reel_r * 0.4, 1);
  gfx_r = 0.35; gfx_g = 0.4; gfx_b = 0.3;
  i = 0;
  loop(3,
    a = -reel_angle + i * 2 * $pi / 3;
    gfx_line(reel_cx2, reel_cy,
             reel_cx2 + cos(a) * reel_r * 0.85,
             reel_cy + sin(a) * reel_r * 0.85);
    i += 1;
  );

  // Tape path between reels
  gfx_r = 0.4; gfx_g = 0.35; gfx_b = 0.25;
  tape_y = reel_cy - reel_r - 5;
  gfx_line(reel_cx1, tape_y, reel_cx2, tape_y);

  // --- Head indicators ---
  head_y = tape_y - 12;
  head_spacing = (reel_cx2 - reel_cx1) / 4;

  // Head 1
  h1_on ? ( gfx_r = 0.2; gfx_g = 0.9; gfx_b = 0.3; )
        : ( gfx_r = 0.2; gfx_g = 0.25; gfx_b = 0.15; );
  hx = reel_cx1 + head_spacing;
  gfx_rect(hx - 4, head_y - 6, 8, 12);
  gfx_r = 0.5; gfx_g = 0.6; gfx_b = 0.4;
  gfx_x = hx - 2; gfx_y = head_y - 20;
  gfx_drawstr("1");

  // Head 2
  h2_on ? ( gfx_r = 0.2; gfx_g = 0.9; gfx_b = 0.3; )
        : ( gfx_r = 0.2; gfx_g = 0.25; gfx_b = 0.15; );
  hx = reel_cx1 + head_spacing * 2;
  gfx_rect(hx - 4, head_y - 6, 8, 12);
  gfx_r = 0.5; gfx_g = 0.6; gfx_b = 0.4;
  gfx_x = hx - 2; gfx_y = head_y - 20;
  gfx_drawstr("2");

  // Head 3
  h3_on ? ( gfx_r = 0.2; gfx_g = 0.9; gfx_b = 0.3; )
        : ( gfx_r = 0.2; gfx_g = 0.25; gfx_b = 0.15; );
  hx = reel_cx1 + head_spacing * 3;
  gfx_rect(hx - 4, head_y - 6, 8, 12);
  gfx_r = 0.5; gfx_g = 0.6; gfx_b = 0.4;
  gfx_x = hx - 2; gfx_y = head_y - 20;
  gfx_drawstr("3");

  // --- Wow/flutter indicator ---
  gfx_r = 0.3; gfx_g = 0.4; gfx_b = 0.25;
  gfx_x = 10; gfx_y = gfx_h - 18;
  gfx_drawstr("W&F: ");
  gfx_drawnumber(slider7, 0);
  gfx_drawstr("%  Age: ");
  gfx_drawnumber(slider8, 0);
  gfx_drawstr("%  Spring: ");
  gfx_drawnumber(slider9, 0);
  gfx_drawstr("%");
